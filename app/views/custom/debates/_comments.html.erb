<% cache [locale_and_user_status, @current_order, commentable_cache_key(@debate), @comment_tree.comments, @comment_tree.comment_authors, @debate.comments_count] do %>
  <div class="row comments">
    <div id="comments" class="small-12 column">
      <h3>
        <%= t("debates.show.comments_title") %>
        <span class="js-comments-count">(<%= @debate.comments_count %>)</span>
      </h3>

      <%= render "shared/wide_order_selector", i18n_namespace: "comments" %>

      <% comments_allowed = true %>
      <% if user_signed_in? && @projekt && can?(:select, @projekt.debate_phase) %>
        <%= render "comments/form", { commentable: @debate, parent_id: nil } %>

      <% elsif user_signed_in? && @projekt %>
        <% comments_allowed = false %>

        <div class='commenting-not-allowed'>
          <ul>
            <% if current_user.geozone && @projekt.debate_phase.geozones.any? && !@projekt.debate_phase.geozone_ids.include?(current_user.geozone.id) %>
							<li><%= t('custom.comments.restricted.geo_limitation', geozones: @projekt.debate_phase.geozones.names.join(', ')) %></li>
            <% end %>

            <% if @projekt.debate_phase.active && @projekt.debate_phase.expired? %>
							<li><%= t('custom.comments.restricted.debate_phase_expired')%></li>
            <% end %>

            <% if !@projekt.debate_phase.active %>
							<li><%= t('custom.comments.restricted.debate_phase_expired')%></li>
            <% end %>

          </ul>
        </div>

      <% elsif user_signed_in? && @projekt.nil? %>
        <%= render "comments/form", { commentable: @debate, parent_id: nil } %>

      <% else %>
        <br>
        <%= render "shared/login_to_comment" %>
      <% end %>

      <%= render "comments/comment_list", comments: @comment_tree.root_comments, comments_allowed: comments_allowed %>
      <%= paginate @comment_tree.root_comments %>
    </div>
  </div>
<% end %>
