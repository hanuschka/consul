<%= content_for :body_class, "debates-show" %>

<% provide :title do %><%= @debate.title %><% end %>
<% content_for :canonical do %>
  <%= render "shared/canonical", href: debate_url(@debate) %>
<% end %>

<% provide :social_media_meta_tags do %>
  <%= render "shared/social_media_meta_tags",
    social_url: debate_url(@debate),
    social_title: @debate.title,
    social_description: @debate.description,
    twitter_image_url: (@debate.image.present? ? polymorphic_path(@debate.image) : nil),
    og_image_url: (@debate.image.present? ? polymorphic_path(@debate.image) : nil) %>
<% end %>

<main>
  <div id="<%= dom_id(@debate) %>" >
    <div class="layout-main-column">
      <div class="layout-left-column">
        <h1 class="resource-page--title"><%= "#{@debate.author.name} startet eine Diskussion"  %></h1>
        <div class="resource-page--title-subline">
          <%= render_custom_block('debate_show_welcome_text', custom_prefix: @debate.author.name , default_content: t('custom.debates.show.welcome_default_text')) %>
        </div>

        <% if @debate.conflictive? %>
          <div data-alert class="callout alert margin-top">
            <strong><%= t("debates.show.flag") %></strong>
          </div>
        <% end %>

      </div>
      <div class="sidebar-placeholder"></div>
    </div>

    <div class="layout-main-column">
      <div class="layout-left-column">
        <div class="resource-page-banner">
          <div class="resource-page-banner--text-section">
            <h2 class="resource-page-banner--title">
              <%= @debate.title %>
            </h2>

            <div class="resourece-page-banner--details">
              <div class="resourece-page-banner--detail">
                <i class="fa fa-calendar"></i>
                <%= l(@debate.created_at, format: :new_date_with_year) %>
              </div>
              <div class="resourece-page-banner--detail">
                <i class="fa fa-comment"></i>
                <%= @debate.comments.count %> Kommentare
              </div>
              <div class="resourece-page-banner--detail">
                <%= link_to(projekt_path(@debate.projekt)) do %>
                  <i class="fa fa-code-branch"></i>
                  Zugeh√∂riges Projekt:
                  <%= @debate.projekt.name %>
                <% end %>
              </div>
            </div>
          </div>

          <%# <%= image_tag(@debate.image.variant(:large), class: "resource-page-banner--image") %>
          <div class="resource-page-banner--image">
            <%= render(
              Shared::ResourceImageComponent.new(
                image_url: @debate.image&.variant(:large),
                image_placeholder_icon_class: "fa-comments",
                resource_name: 'debate'
              )
            )
          %>
          </div>
        </div>

        <div class="resource-page--description new-card">
          <%= auto_link_already_sanitized_html wysiwyg(@debate.description) %>
        </div>

        <% if projekt_feature?(@debate.projekt, 'debates.show_related_content') %>
          <%= render "relationable/related_content", relationable: @debate %>
        <% end %>

        <% if projekt_feature?(@debate.projekt, 'debates.show_comments') %>
          <%= render Shared::NewCommentsComponent.new(@debate, @comment_tree) %>
        <% end %>
      </div>
    <aside class="sidebar">
      <%= render Users::ResourceAuthorComponent.new(user: @debate.author) %>

      <% if current_user.present? && current_user.administrator? %>
        <%= render(Shared::SidebarCardComponent.new(title: t("custom.shared.show.admin"), icon_name: "cog")) do |c| %>
          <% c.body do %>
            <div class="js-moderator-debate-actions">
              <%= render "actions", debate: @debate %>
            </div>
          <% end %>
        <% end %>
      <% end %>

      <% if @debate.editable_by?(current_user) %>
        <%= render(Shared::SidebarCardComponent.new(title: t("debates.show.author"), icon_name: "cog")) do |c| %>
          <% c.body do %>
            <%= link_to edit_debate_path(@debate), class: "button hollow expanded" do %>
              <span class="icon icon-edit"></span>
              <%= t("debates.show.edit_debate_link") %>
            <% end %>
          <% end %>
        <% end %>
      <% end %>

      <% if projekt_feature?(@debate&.projekt, 'debates.allow_voting') %>
        <%= render(Shared::SidebarCardComponent.new(title: t("votes.supports"), icon_name: "vote-yea")) do |c| %>
          <% c.body do %>
            <div id="<%= dom_id(@debate) %>_votes" class="debate-page--votes">
              <%= render Debates::VotesComponent.new(@debate) %>
            </div>
          <% end %>

          <% c.additional_section do %>
            <div id="debate_<%= @debate.id %>_votes_count">
              <%= t("debates.debate.votes", count: @debate.votes_score) %>
            </div>
          <% end %>

          <% if projekt_feature?(@debate.projekt, 'debates.show_report_button_in_sidebar') %>
            <% if show_flag_action?(@debate) || show_unflag_action?(@debate) %>
              <% c.additional_section do %>
                <%= render Shared::ReportResourceComponent.new(@debate) %>
              <% end %>
            <% end %>
          <% end %>
        <% end %>
      <% end %>

      <% if projekt_feature?(@debate.projekt, "debates.allow_attached_documents") %>
        <%= render(Shared::SidebarCardComponent.new(title: t("documents.title"), icon_name: "file")) do |c| %>
          <% c.body do %>
            <%= render "documents/documents",
              documents: @debate.documents,
              max_documents_allowed: Debate.max_documents_allowed
            %>
          <% end %>
        <% end %>
      <% end %>

      <% if @debate.tags.present? %>
        <%= render(Shared::SidebarCardComponent.new(title: "Tags", icon_name: "tag")) do |c| %>
          <% c.body do %>
            <%= render "shared/tags", taggable: @debate, limit: 5 %>
          <% end %>
        <% end %>
      <% end %>

      <%= render(Shared::SidebarCardComponent.new(title: t("debates.show.share"), icon_name: "share-alt")) do |c| %>
        <% c.body do %>
          <%= render "shared/social_share",
            share_title: t("debates.show.share"),
            title: @debate.title,
            url: debate_url(@debate),
            description: @debate.title,
            mobile: @debate.title
          %>
        <% end %>
      <% end %>

      <% if current_user && projekt_feature?(@debate.projekt, 'debates.show_related_content') %>
        <%= render(Shared::SidebarCardComponent.new(title: t("custom.shared.show.related_title"), icon_name: "share-alt")) do |c| %>
          <% c.body do %>
            <p><%= t("custom.shared.show.related_text") %></p>
            <%= link_to '#related_content', data: {toggle: "related_content"}, id: "add-related-content", class: "button hollow expanded" do %>
              <%= t("custom.shared.show.related_button") %>
            <% end %>
          <% end %>
        <% end %>
      <% end %>
    </aside>
    </div>
  </div>
</main>
