<% provide :title do %>
  <%= t("shared.search_results") %>
<% end %>

<% content_for :header_addon do %>
  <%= render "shared/search_form",
    search_path: search_path(page: 1),
    i18n_namespace: "debates.index.search_form" %>
<% end %>
<% content_for :canonical do %>
  <%= render "shared/canonical", href: search_url %>
<% end %>

<main>
<div class="highlight no-margin-top padding margin-bottom search-header">
  <div class="row">
    <div class="small-12 column">
        <h2><%= t("shared.search_results") %></h2>
  <div id="search_form" class="search-form-header">
    <h1 class="show-for-sr"><%= t("shared.outline.searcher") %></h1>
    <%= form_tag search_path, method: :get do %>
      <div class="input-group">
        <label for="search_text" class="big-search-label">
          <span class="show-for-sr"><%= t("search.search_form.title") %></span>
          <input type="text" name="q" placeholder="<%= t("search.search_form.placeholder") %>"
                                      class="input-group-field"
                                      value="<%= params[:q] %>" id="search_text">
        </label>
        <div class="input-group-button">
          <button type="submit" class="button" title="<%= t("search.search_form.button") %>">
            <span class="show-for-sr"><%= t("search.search_form.button") %></span>
            <span class="icon-search"></span>
          </button>
        </div>
      </div>
    <% end %>
  </div>

    </div>
  </div>
</div>


<div class="row">
  <div id="debates" class="debates-list small-12 medium-9 column">

    <%= render "shared/banner" %>

    <%-searches = ['debate', 'proposal', 'voting', 'budget', 'legislation_process', 'comment', 'page']%>

    <ul class='search-modules'>
      <%-total_count = @results.aggregations.genres.buckets.map{|d| d.doc_count}.sum%>
      <li class="<%if params[:section].blank?%>selected<%end%>"><%=link_to t("search.tabs.all", doc_count: total_count || 0), {section: nil, q: params[:q]}%></li>
      <%@results.aggregations.genres.buckets.each do |aggr| %>
        <li class="<%if params[:section] == aggr["key"]%>selected<%end%>"
            ><%=link_to t("search.tabs.#{aggr["key"]}", doc_count: aggr&.doc_count || 0), {section: aggr["key"], q: params[:q], tag: params[:tag], projekts: params[:projekts] }%></li>
      <%end%>

    </ul>

    <% if @results.any? || current_user.blank? %>
      <%@results.each do |result|%>
        <%= render "result", result: result %>
      <%end%>
    <% else %>
       No results
    <% end %>
    <%= paginate @results, current_page: params[:page]&.to_i || 1, per_page: 10 %>

  </div>

  <div class="small-12 medium-3 column">

    <aside class="margin-bottom">
      <% projekts = @results.aggregations.selected_section ? @results.aggregations.selected_section.projekts : @results.aggregations.projekts %>
      <%= render "shared/projekts_sidebar", aggregations: projekts.buckets.map{ |b| [ b['key'], b.doc_count] }.to_h %>

      <%-categories =  @results.aggregations.selected_section ? @results.aggregations.selected_section.tags : @results.aggregations.tags%>
      <%=render "categories", categories: categories%>
    </aside>
  </div>

</div>
</main>
