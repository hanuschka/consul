<% params[:projekts] ||= '' %>

<% projekts.each do |projekt| %>
  <% projekt_and_nested_projekts_ids = projekt.all_children_ids.push(projekt.id) %>
  <% selected_projekts = params[:projekts].split(',')  %>

  <% toggle_projekt = (selected_projekts & projekt_and_nested_projekts_ids.map(&:to_s)).any? ? true : false %>
  <% projekt.id.to_s.in?(selected_projekts) ? label_class = 'label-selected' : label_class = 'label_regular' %>

  <ul>
    <li class='' aria-expanded=<%= toggle_projekt %> >
      <%= label_tag projekt.name, class: label_class do %>
        <%= check_box_tag projekt.name, projekt.id, projekt.id.to_s.in?(params[:projekts].split(',')), { class: 'js-filter-projekt' }  %>
        <%= projekt.name %>
        <%= "(#{aggregations[projekt.id]})" if aggregations[projekt.id].present?  %>
        <span class="checkmark"></span>
      <% end %>

      <% if projekt.children.any? %>
        <span class='js-icon-toggle-child-projekts toggle-arrow'></span>
      <% end %>
    </li>

    <% if projekt.children.any? %>
      <%= render partial: "shared/projekts_filter", locals: { projekts: projekt.children.with_order_number, aggregations: aggregations } %>
    <% end %>

  </ul>
<% end %>
